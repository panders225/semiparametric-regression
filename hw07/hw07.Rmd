---
title: "Assignment 07 - STAT 689"
author: "Philip Anderson; panders2@tamu.edu"
date: "2/26/2018"
output: pdf_document
---

```{r setup, message=FALSE}
library("mgcv")
```

```{r}
# read in our data set 
fram <- read.csv("/Users/panders2/Documents/schools/tamu/stat_689/homework/semiparametric-regression/misc/framingham_with_lsbp_and_lcholest.csv")
names(fram) <- tolower(names(fram))
str(fram)
```

Our response variable Y, equals chd; our predictors are lsbp, lcholest, age, and smoking status.  

# Question 1
Fit a logistic gam with only LSBP modeled as a spline.

```{r}
logit1 <- mgcv::gam(chd ~ s(lsbp, k=23, bs="cr") + lcholest + age + smoker
                    , family=binomial(link="logit")
                    , data=fram
                    )
summary(logit1)
```


P-values for 4 predictors are as follows:

```{r}
pval_smry <- function(gam_mod) {
  gam_smry <- summary(gam_mod)
  print("Parametric Term p-values:")
  print(gam_smry$pTerms.pv)
  cat("\nSmoothed Term p-values:\n")
  cat(gam_smry$s.pv)
  
}

pval_smry(logit1)
```

Note from the output of the summary statement that we are not explaining a great deal of the deviance present within the data, so our model has some room for improvement.  Nonetheless, the p-value on the smoothed term suggests that _LSBP_ should be modeled as a spline.

# Question 2
Fit a logisitc gam with only Lcholest modeled as a spline.

```{r}
logit2 <- mgcv::gam(chd ~ lsbp + s(lcholest, k=23, bs="cr") + age + smoker
                    , family=binomial(link="logit")
                    , data=fram
                    )
summary(logit2)

```

```{r}
pval_smry(logit2)
```

It looks as though the _lcholest_ variable should be modeled within a spline function.

# Question 3
Fit a logistic gam with only age modeled as a spline.

```{r}
logit3 <- mgcv::gam(chd ~ lsbp + lcholest + s(age, k=23, bs="cr") + smoker
                    , family=binomial(link="logit")
                    , data=fram
                    )
summary(logit3)
``` 

```{r}
pval_smry(logit3)
```

From the above p-values, it appears as though the _age_ term should be smoothed as well.

# Question 4
Fit the model with all continuous terms modeled as splines; and smoking_status as-is.

```{r}
logit4 <- mgcv::gam(chd ~ s(lsbp, k=23, bs="cr") + 
                      s(lcholest, k=23, bs="cr") + 
                      s(age, k=23, bs="cr") + smoker
                    , family=binomial(link="logit")
                    , data=fram
                    )
summary(logit4)

```

```{r}
pval_smry(logit4)
```

From the above summaries, it appears that all of the spline terms we put into the fourth logistic regression are appropriate.  

# Question 5
Refit the model from Question 4, with only the terms that you picked as being significant under spline transformation.  I elected to model all continuous terms as splines, so I will simply repeat the model from question 4.

```{r}
logit5 <- mgcv::gam(chd ~ s(lsbp, k=23, bs="cr") + 
                      s(lcholest, k=23, bs="cr") + 
                      s(age, k=23, bs="cr") + smoker
                    , family=binomial(link="logit")
                    , data=fram
                    )
```

# Question 6
Test whether the model from Question 5 differs from the model where nothing is modeled as a spline.

```{r}
# the null model will be a standard logistic regression
logit_null <- mgcv::gam(chd ~ lsbp + lcholest + age + smoker
                        , family=binomial(link="logit")
                        , data=fram
                      )
```

```{r}
# now, conduct our test
(aov_tab <- anova(logit5, logit_null, test="Chisq"))
```

```{r}
print("P-value from test given by:")
print(aov_tab$`Pr(>Chi)`)
```

The model with 3 smoothed terms is not significantly different from the model that contains no smoothed terms.  


# Question 7
For the model that passed Question 5, plot the smooth fits.

```{r}
color_plot_ls <- function(mod_obj,var_name, var_idx, x_label) {
  
  plot(mod_obj, shade=TRUE, shade.col="palegreen"
       , select=var_idx, ylab="Logit of Prob of CHD",
       xlab=x_label, main="link_scale", rug=FALSE)
  rug(fram$var_name, col="dodgerblue", quiet=TRUE)
}
par(mfrow=c(2,2))
color_plot_ls(mod_obj=logit5, var_name=lsbp, var_idx=1, x_label="LSBP")
color_plot_ls(mod_obj=logit5, var_name=lcholest, var_idx=2, x_label="LCholest")
color_plot_ls(mod_obj=logit5, var_name=age, var_idx=3, x_label="Age")
par(mfrow=c(1,1))

```


```{r}
color_plot_rs <- function(mod_obj, var_name, var_idx, x_label){
  
  plot(mod_obj,shade = TRUE,shade.col = "palegreen",
       trans = plogis, scale = FALSE, select = var_idx, 
       ylab = "Probability of CHD", 
       xlab=x_label,main = "response scale",rug = FALSE)
  rug(fram$var_name,col = "dodgerblue",quiet = TRUE)

}

par(mfrow=c(2,2))
color_plot_rs(mod_obj=logit5, var_name=lsbp, var_idx=1, x_label="LSBP")
color_plot_rs(mod_obj=logit5, var_name=lcholest, var_idx=2, x_label="LCholest")
color_plot_rs(mod_obj=logit5, var_name=age, var_idx=3, x_label="Age")
par(mfrow=c(1,1))

```


# Question 8
For the regressions in question 1-5, state the p-value of the smoking variable and state the odds ratio of it.

```{r}
smok <- function(mod_obj, mod_name) {
  cat(mod_name)
  smry <- summary(mod_obj)
  cat("\nsmoker term p-value: ")
  cat(smry$p.pv['smoker'])
  cat("\nodds of CHD for a smoker vs. non-smoker: ")
  cat(exp(smry$p.coeff['smoker']))
  cat("\n----------\n")
}

smok(mod_obj=logit1, mod_name="Model from Question 1")
smok(mod_obj=logit2, mod_name="Model from Question 2")
smok(mod_obj=logit3, mod_name="Model from Question 3")
smok(mod_obj=logit4, mod_name="Model from Question 4")
smok(mod_obj=logit5, mod_name="Model from Question 5")

```

There is not a dramatic difference between the models fit in Questions 1-5.  This implies that the impact of smoking_status on a CHD does not differ much in the presence of different smoothing terms.


# Question 9